name: Nexus Elite CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  quality-assurance:
    runs-on: ubuntu-latest
    env:
      # This ensures the 'Nexus' folder and root are searchable for imports
      PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/Nexus

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Force Install Core Dependencies
        # Ensuring dynamic logic tools are present regardless of requirements.txt
        run: |
          python -m pip install --upgrade pip
          pip install ccxt pandas numpy

      - name: Verify Import Structure
        # Checks if trainer_daemon can actually see the engine
        run: |
          python -c "import sys; print(f'Paths: {sys.path}'); import trainer_daemon; print('✅ Imports Verified')"

      - name: Logic & Calculation Audit
        # Verifies math logic is dynamic and functional
        run: |
          python -c "
          import pandas as pd
          import numpy as np
          from signals import compute_atr
          # Mock data for verification
          df = pd.DataFrame({
              'high': [10, 12, 11, 13, 15],
              'low': [9, 10, 9, 11, 12],
              'close': [9.5, 11, 10, 12, 14]
          })
          atr = compute_atr(df, period=3)
          val = atr.iloc[-1]
          assert not np.isnan(val) and val > 0, f'ATR Calculation Error: {val}'
          print(f'✅ Dynamic Math Verified: ATR={val}')
          "

      - name: Database & Path Validation
        # Ensures 'data' directory and schema are created dynamically
        run: |
          python -c "
          from engine.db import init_db
          import os, sqlite3
          init_db()
          db_path = 'data/trading.db'
          if os.path.exists(db_path):
              conn = sqlite3.connect(db_path)
              cursor = conn.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND name='signals';\")
              assert cursor.fetchone() is not None
              print('✅ DB Schema Integrity Verified')
          else:
              raise FileNotFoundError(f'DB not found at {db_path}')
          "

      - name: Full-File Syntax Check
        # Catches indentation/transfer errors from full-file rewrites
        run: |
          python -m compileall .
          echo "✅ No indentation or syntax errors found."

  discord-failure-notify:
    # This job only runs if the quality-assurance job fails
    needs: quality-assurance
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Discord Webhook secret is missing. Skipping notification."
          else
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"❌ **Nexus CI/CD Failure**: Logic or Import error detected on branch ${{ github.ref_name }}. Please check GitHub Actions logs.\"}" \
                 $DISCORD_WEBHOOK
          fi
